<!doctype html>
<html>
  <head>
    <title>Checkers</title>
    <link rel="stylesheet" type="text/css" href="reset.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
      game, game-list, game-id, turn, winner, player {
         display: block;
      }
      game-list {
         position: fixed;
         width: 150px;
         top: 5px;
         left: 5px;
         background: white;
      }
      game-info {
         width: 250px;
         position: absolute;
         top: 5px;
         left: 635px;
      }
      game {
         position: relative;
         width: 650px;
         visibility: hidden;
         margin: 5px auto;
      }
      board {
         display: table;
         border: solid black 5px;
      }
      row {
         display: table-row;
      }
      space {
         display: table-cell;
         border: 1px solid black;
         vertical-align: middle;
         width: 75px;
         height: 75px;
         background: #d2d183;
      }
      space.usable {
         background: #505032;
      }
      piece {
         display: block;
         font-family: "Courier New";
         font-weight: bold;
         font-size: x-large;
         color: white;
         width: 60px;
         height: 60px;
         line-height: 60px;
         border-radius: 30px;
         text-align: center;
         margin: 0 auto;
      }
      piece.black {
         background: black;
      }
      piece.red {
         background: red;
      }
      piece.hidden {
         display: none;
      }
      piece.dragging {
         position: fixed;
         opacity: 0.7;
         z-index: 100;
      }
    </style>
  </head>
  <body>
    
    <game-list></game-list>
    <game>
      <game-info>
         <game-id></game-id>
         <winner></winner>
         <turn></turn>
         <player></player>
      </game-info>
      <board></board>
    </game>

    <script src="/socket.io/socket.io.js"></script>
    <script>

      var socket = io();

      function getElement(name) {
         var turnElems = document.getElementsByTagName(name);
         if (turnElems.length == 0) {
            var newElem = document.createElement(name);
            document.body.appendChild(newElem);
            return newElem;
         }
         return turnElems[0];
      }

      function getSpace(x, y) {
         var boardElem = getElement('board');
         var rowElem = boardElem.getElementsByTagName('row')[y];
         var cellElem = rowElem.getElementsByTagName('space')[x];
         return cellElem;
      }

      function getCoords(spaceElem) {
         var boardElem = getElement('board');
         var rowElems = boardElem.getElementsByTagName('row');
         for (var i=0; i<rowElems.length; i++) {
            var spaceElems = rowElems[i].getElementsByTagName('space');
            for (var j=0; j<spaceElems.length; j++) {
               if (spaceElem === spaceElems[j]) {
                  return { x: j, y: i };
               }
            }
         }
      }

      function move(src, dst) {
         var cmd = 'MOVE ' + src.x + ' ' + src.y + ' ' + dst.x + ' ' + dst.y;
         socket.emit('commands', cmd);
      }

      function allowDrop(dragEvent) {
         if (this.className == 'usable' && this.childNodes.length == 0) {
            dragEvent.preventDefault();
         }
      }

      var touchSrc;
      var dragPiece;
      function touchDrag(touchEvent) {
         touchEvent.preventDefault(); // Prevent scrolling
         var srcSpace = this.parentNode;
         if (touchEvent.changedTouches.length == 1 
             && this.className == player && player == turn) {
            var touch = touchEvent.changedTouches[0];
            touchSrc = getCoords(srcSpace);
            dragPiece = this.cloneNode(true);
            dragPiece.style.top = (touch.clientY - (this.offsetHeight / 2)) + 'px';
            dragPiece.style.left = (touch.clientX - (this.offsetWidth / 2)) + 'px';
            dragPiece.className += ' dragging';
            getElement('game').appendChild(dragPiece);
            this.className += ' hidden';
         } else
            touchSrc = undefined;
      }

      function touchMove(touchEvent) {
         if (dragPiece && touchEvent.targetTouches.length == 1) {
            var touch = touchEvent.targetTouches[0];
            dragPiece.style.top = (touch.clientY - (dragPiece.offsetHeight / 2)) + 'px';
            dragPiece.style.left = (touch.clientX - (dragPiece.offsetWidth / 2)) + 'px';
         }
      }

      function touchDrop(touchEvent) {
         touchEvent.preventDefault();
         if (dragPiece && touchSrc && touchEvent.changedTouches.length >= 1) {
            var touch = touchEvent.changedTouches[0];
            getElement('game').removeChild(dragPiece);
            dragPiece = undefined;
            var dropElem = document.elementFromPoint(touch.clientX, touch.clientY);
            if (dropElem.className == 'usable' && dropElem.childNodes.length == 0) {
               var touchDst = getCoords(dropElem);
               move(touchSrc, touchDst);
            }
            var srcPieceElem = getSpace(touchSrc.x, touchSrc.y).childNodes[0];
            srcPieceElem.className = srcPieceElem.className.replace(' hidden','');
         }
      }

      function dragPiece(dragEvent) {
         var dragSrc = getCoords(this.parentNode);
         dragEvent.dataTransfer.setData('text/plain', JSON.stringify(dragSrc));
      }

      function dropPiece(dropEvent) {
         dropEvent.preventDefault();
         var dropDst = getCoords(dropEvent.target);
         var dragSrc = JSON.parse(dropEvent.dataTransfer.getData('text/plain'));
         move(dragSrc, dropDst);
      }

      socket.on('BOARD', function(data) {
         var boardElem = getElement('board');
         boardElem.innerHTML='';
         var rows = data.split('|');
         for (var i=0; i<rows.length; i++) {
            var rowElem = document.createElement('row');
            boardElem.appendChild(rowElem);
            var row = rows[i];
            var pieces = row.split('');
            for (var j=0; j<pieces.length; j++) {
               var spaceElem = document.createElement('space');
               rowElem.appendChild(spaceElem);
               if ((j + (i % 2)) % 2 != 0) {
                  spaceElem.className = 'usable';
                  spaceElem.ondragover = allowDrop;
                  spaceElem.ondrop = dropPiece;
               }
               var piece = pieces[j];
               var pieceElem = document.createElement('piece');
               pieceElem.ondragstart = dragPiece;
               pieceElem.addEventListener('touchstart', touchDrag);
               pieceElem.addEventListener('touchmove', touchMove);
               pieceElem.addEventListener('touchend', touchDrop);
               if (piece.toLowerCase() == 'r') {
                  pieceElem.className = 'red';
               } else if (piece.toLowerCase() == 'b') {
                  pieceElem.className = 'black';
               } else {
                  continue;
               }
               if (piece >= 'A' && piece <= 'Z') pieceElem.innerHTML = '&#9812';
               spaceElem.appendChild(pieceElem);
            }
         }
         getElement('game').style.visibility = 'visible';
      });

      function enableDragging(turn) {
         var boardElem = getElement('board');
         var pieceElems = boardElem.getElementsByTagName('piece');
         for (var i=0; i<pieceElems.length; i++) {
            var pieceElem = pieceElems[i];
            pieceElem.draggable = turn == player && player == pieceElem.className;
         }
      }

      socket.on('MOVED', function(data) {
         var coords = data.split(' ');
         var srcx = coords[0], srcy = coords[1], dstx = coords[2], dsty = coords[3];
         var srcCellElem = getSpace(srcx, srcy), dstCellElem = getSpace(dstx, dsty);
         var pieceElem = srcCellElem.childNodes[0];
         srcCellElem.removeChild(pieceElem);
         dstCellElem.appendChild(pieceElem);
      });

      socket.on('CAPTURED', function(data) {
         var coords = data.split(' ');
         var x = coords[0], y = coords[1];
         var cellElem = getSpace(x, y);
         cellElem.removeChild(cellElem.childNodes[0]);
      });

      socket.on('KING', function(data) {
         var coords = data.split(' ');
         var x = coords[0], y = coords[1];
         var pieceElem = getSpace(x, y).childNodes[0];
         pieceElem.innerHTML = pieceElem.innerHTML = '&#9812';
      });

      var turn;
      socket.on('TURN', function(data) {
         var msg;
         turn = data;
         if (data == 'waiting') {
            msg = 'Waiting for players';
         } else if (player && player == turn) {
            msg = 'Your turn';
         }else {
            msg = data.charAt(0).toUpperCase() + data.slice(1) + "'s turn";
         }
         getElement('turn').innerHTML = msg;
         enableDragging(data);
      });

      socket.on('WINNER', function(data) {
         getElement('winner').innerHTML = 'Winner: ' + data;
      });

      socket.on('GAME_ID', function(data) {
         getElement('game-id').innerHTML = 'Game ' + data;
      });

      var player;
      socket.on('YOU_ARE', function(data) {
         player = data;
         getElement('player').innerHTML = 'Your pieces are ' + data;
      });

      function join(gameId) {
         socket.emit('commands', 'JOIN ' + gameId);
      }

      function newGame() {
         socket.emit('commands', 'NEW');
      }

      socket.on('LIST', function(data) {
         if (data) {
            var gameList = data.split(' ');
            join(gameList[0]);
         } else {
            newGame();
         }
      });

      function gameList() {
         console.log('sending game list command');
         socket.emit('commands', 'LIST');
      }

      document.body.onload = gameList;
    </script>
  </body>
</html>
