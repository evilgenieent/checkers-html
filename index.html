<!doctype html>
<html>
  <head>
    <title>Checkers Spectator</title>

    <style>
      board {
         display: table;
         border: solid black 1px;
      }
      row {
         display: table-row;
      }
      space {
         display: table-cell;
         width: 25px;
         height: 25px;
         border: 1px solid black;
         text-align: center;
         vertical-align: middle;
      }
      piece {
         color: white;
         font-family: "Courier New";
      }
      piece.black {
         background: black;
      }
      piece.red {
         background: red;
      }
    </style>
  </head>
  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      var status_types = ['BOARD', 'TURN', 'MOVED', 'CAPTURED', 'KING'];

      function get_handler(type) {
         return function(data) { console.log(type + ': ' + data); };
      }

      for (var i=0; i<status_types.length; i++) {
         var status_type = status_types[i];
         socket.on(status_type, get_handler(status_type));
      }

      socket.on('LIST SPECTATE', function(data) {
         var game_ids = data.split(' ');
         // Doesn't handle empty list well
         socket.emit('commands', 'SPECTATE ' + game_ids[0]);
      });

      socket.on('BOARD', function(data) {
         var boardElem = getElement('board');
         var rows = data.split('|');
         for (var i=0; i<rows.length; i++) {
            var rowElem = document.createElement('row');
            boardElem.appendChild(rowElem);
            var row = rows[i];
            var pieces = row.split('');
            for (var j=0; j<pieces.length; j++) {
               var spaceElem = document.createElement('space');
               rowElem.appendChild(spaceElem);
               var piece = pieces[j];
               var pieceElem = document.createElement('piece');
               if (piece.toLowerCase() == 'r') {
                  pieceElem.className='red';
               } else if (piece.toLowerCase() == 'b') {
                  pieceElem.className='black';
               } else {
                  continue;
               }
               pieceElem.innerHTML = piece;
               spaceElem.appendChild(pieceElem);
            }
         }
      });

      function getElement(name) {
         var turnElems = document.getElementsByTagName(name);
         if (turnElems.length == 0) {
            var newElem = document.createElement(name);
            document.body.appendChild(newElem);
            return newElem;
         }
         return turnElems[0];
      }

      function getCell(x, y) {
         var boardElem = getElement('board');
         var rowElem = boardElem.getElementsByTagName('row')[y];
         var cellElem = rowElem.getElementsByTagName('space')[x];
         return cellElem;
      }

      socket.on('MOVED', function(data) {
         var coords = data.split(' ');
         var srcx = coords[0], srcy = coords[1], dstx = coords[2], dsty = coords[3];
         var srcCellElem = getCell(srcx, srcy), dstCellElem = getCell(dstx, dsty);
         var pieceElem = srcCellElem.childNodes[0];
         srcCellElem.removeChild(pieceElem);
         dstCellElem.appendChild(pieceElem);
      });

      socket.on('CAPTURED', function(data) {
         var coords = data.split(' ');
         var x = coords[0], y = coords[1];
         var cellElem = getCell(x, y);
         cellElem.removeChild(cellElem.childNodes[0]);
      });

      socket.on('KING', function(data) {
         var coords = data.split(' ');
         var x = coords[0], y = coords[1];
         var pieceElem = getCell(x, y).childNodes[0];
         pieceElem.innerHTML = pieceElem.innerHTML.toUpperCase();
      });

      socket.on('TURN', function(data) {
         getElement('turn').innerHTML = data;
      });

      socket.on('WINNER', function(data) {
         getElement('winner').innerHTML = data;
      });

      socket.on('GAME_ID', function(data) {
         getElement('game-id').innerHTML = data;
      });

      function game_list() {
         console.log('sending game list command');
         socket.emit('commands', 'LIST SPECTATE');
      }

      document.body.onload = game_list;
    </script>
  </body>
</html>
